<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Service Dashboard</title>
  <!-- Configurazione (carica prima dello script principale) -->
  <!-- config.js per sviluppo locale (opzionale, in .gitignore) -->
  <script src="config.js" onerror="console.log('config.js non trovato, uso config.prod.js')"></script>
  <!-- config.prod.js per produzione (committato) -->
  <script src="config.prod.js"></script>
  <!-- Supabase JS Client via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <style>
    /* ============================================================
       RESET & VARIABILI
    ============================================================ */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --sidebar-w: 320px;
      --header-h: 60px;
      --bg: #f1f5f9;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --text-muted: #64748b;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --escalation: #dc2626;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    /* ============================================================
       SCHERMATA LOGIN
    ============================================================ */
    #screen-login {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 50%, #3b82f6 100%);
    }

    .login-card {
      background: var(--surface);
      border-radius: 20px;
      padding: 48px 40px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.25);
    }

    .login-logo {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-logo .logo-icon {
      width: 64px;
      height: 64px;
      background: var(--primary);
      border-radius: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 16px;
    }

    .login-logo h1 {
      font-size: 22px;
      font-weight: 700;
      color: var(--text);
    }

    .login-logo p {
      color: var(--text-muted);
      font-size: 14px;
      margin-top: 4px;
    }

    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 11px 14px;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      outline: none;
      transition: border-color .2s;
      background: var(--surface);
      color: var(--text);
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--primary);
    }

    .form-group select {
      cursor: pointer;
    }

    .btn-primary {
      width: 100%;
      padding: 13px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s, transform .1s;
      margin-top: 8px;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-primary:active {
      transform: scale(0.99);
    }

    .btn-primary:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    #login-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #b91c1c;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      margin-top: 12px;
      display: none;
    }

    .mode-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all .2s;
    }

    .mode-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .mode-btn:hover:not(.active) {
      color: var(--text);
    }

    /* ============================================================
       LAYOUT PRINCIPALE
    ============================================================ */
    #screen-app {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    #app-header {
      height: var(--header-h);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 16px;
      flex-shrink: 0;
      z-index: 100;
    }

    .header-logo {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }

    .header-logo span {
      color: var(--text-muted);
      font-weight: 400;
      font-size: 14px;
      margin-left: 8px;
    }

    #header-tabs {
      display: flex;
      gap: 4px;
      margin-left: auto;
    }

    .tab-btn {
      padding: 6px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      background: transparent;
      color: var(--text-muted);
      transition: background .15s, color .15s;
    }

    .tab-btn.active {
      background: var(--primary);
      color: #fff;
    }

    .tab-btn:hover:not(.active) {
      background: var(--bg);
    }

    #header-user {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-muted);
      font-size: 13px;
    }

    #header-user strong {
      color: var(--text);
    }

    .btn-logout {
      padding: 6px 14px;
      border-radius: 8px;
      border: 1.5px solid var(--border);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 12px;
      transition: border-color .15s, color .15s;
    }

    .btn-logout:hover {
      border-color: var(--danger);
      color: var(--danger);
    }

    /* Body layout */
    #app-body {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* ============================================================
       SIDEBAR CONVERSAZIONI
    ============================================================ */
    #sidebar {
      width: var(--sidebar-w);
      flex-shrink: 0;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    #sidebar-header h2 {
      font-size: 14px;
      font-weight: 700;
    }

    #sidebar-badge {
      background: var(--escalation);
      color: #fff;
      border-radius: 12px;
      padding: 2px 10px;
      font-size: 12px;
      font-weight: 700;
      display: none;
    }

    #sidebar-badge.visible {
      display: inline;
    }

    #sidebar-filters {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }

    .filter-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 6px 14px;
      border-radius: 8px;
      border: 1.5px solid var(--border);
      background: transparent;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap;
    }

    .filter-btn:hover:not(.active) {
      background: var(--bg);
      border-color: var(--primary);
    }

    .filter-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    .filter-btn.channel-btn {
      padding: 5px 12px;
      font-size: 11px;
    }

    #conv-list {
      flex: 1;
      overflow-y: auto;
    }

    #conv-list::-webkit-scrollbar {
      width: 4px;
    }

    #conv-list::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .conv-item {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background .1s;
      position: relative;
    }

    .conv-item:hover {
      background: var(--bg);
    }

    .conv-item.active {
      background: #eff6ff;
      border-right: 3px solid var(--primary);
    }

    .conv-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .conv-item-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .conv-item-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .conv-item-preview {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 6px;
    }

    .conv-item-footer {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge {
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-escalation {
      background: #fef2f2;
      color: var(--escalation);
      border: 1px solid #fecaca;
    }

    .badge-ai {
      background: #eff6ff;
      color: var(--primary);
      border: 1px solid #bfdbfe;
    }

    .badge-chiusa {
      background: #f8fafc;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .badge-canale {
      background: var(--bg);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .badge-unread {
      background: var(--primary);
      color: #fff;
      border: none;
      margin-left: auto;
      min-width: 20px;
      text-align: center;
    }


    #conv-empty {
      padding: 48px 24px;
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
    }

    #conv-empty .empty-icon {
      font-size: 40px;
      margin-bottom: 12px;
    }

    /* ============================================================
       AREA CONVERSAZIONE
    ============================================================ */
    #main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #conv-placeholder {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    #conv-placeholder .ph-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    #conv-placeholder h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    #conv-placeholder p {
      font-size: 14px;
    }

    /* Dettaglio conversazione */
    #conv-detail {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    #conv-detail.visible {
      display: flex;
    }

    #conv-info {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    #conv-info-text {
      flex: 1;
    }

    #conv-info-email {
      font-size: 15px;
      font-weight: 600;
    }

    #conv-info-meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    #conv-info-actions {
      display: flex;
      gap: 8px;
    }

    .btn-action {
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all .15s;
      border: 1.5px solid var(--border);
      background: transparent;
    }

    .btn-chiudi {
      color: var(--text-muted);
    }

    .btn-chiudi:hover {
      border-color: var(--text-muted);
      background: var(--bg);
    }

    #conv-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      background: var(--bg);
    }

    #conv-messages::-webkit-scrollbar {
      width: 4px;
    }

    #conv-messages::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .msg-row {
      display: flex;
      flex-direction: column;
      max-width: 70%;
    }

    .msg-row.utente {
      align-self: flex-end;
      align-items: flex-end;
    }

    .msg-row.assistente,
    .msg-row.operatore {
      align-self: flex-start;
      align-items: flex-start;
    }

    .msg-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
      font-weight: 500;
    }

    .msg-bubble {
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.55;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .msg-row.utente .msg-bubble {
      background: #dbeafe;
      color: #1e3a8a;
      border-bottom-right-radius: 4px;
    }

    .msg-row.assistente .msg-bubble {
      background: var(--surface);
      color: var(--text);
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .msg-row.operatore .msg-bubble {
      background: #dcfce7;
      color: #14532d;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .msg-time {
      font-size: 10px;
      color: #cbd5e1;
      margin-top: 4px;
    }

    #conv-reply {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #conv-reply > div:last-child {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    #reply-input {
      flex: 1;
      min-width: 0; /* Permette al flex di funzionare correttamente */
      width: 100%;
      border: 1.5px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 14px;
      outline: none;
      resize: none;
      max-height: 120px;
      min-height: 50px;
      font-family: inherit;
      transition: border-color .2s;
    }

    #reply-input:focus {
      border-color: var(--primary);
    }

    #btn-send-reply {
      padding: 10px 22px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s;
      white-space: nowrap;
    }

    #btn-send-reply:hover {
      background: var(--primary-dark);
    }

    #btn-send-reply:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    /* ============================================================
       VISTA ADMIN
    ============================================================ */
    #admin-view {
      flex: 1;
      overflow-y: auto;
      padding: 28px;
      display: none;
    }

    #admin-view.visible {
      display: block;
    }

    .admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .admin-header h2 {
      font-size: 20px;
      font-weight: 700;
    }

    .btn-add {
      padding: 9px 18px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-add:hover {
      background: var(--primary-dark);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: var(--surface);
      border-radius: 14px;
      padding: 20px;
      border: 1px solid var(--border);
    }

    .stat-card .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
      margin-bottom: 8px;
    }

    .stat-card .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
    }

    .stat-card .stat-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .negozi-table {
      background: var(--surface);
      border-radius: 14px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .table-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      font-weight: 700;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      padding: 12px 20px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 14px 20px;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    .status-dot.attivo {
      background: var(--success);
    }

    .status-dot.inattivo {
      background: var(--text-muted);
    }

    /* Modal aggiungi negozio */
    #modal-negozio {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #modal-negozio.visible {
      display: flex;
    }

    .modal-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 32px;
      width: 500px;
      max-width: 95vw;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
    }

    .modal-card h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn-cancel {
      padding: 9px 18px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-save {
      padding: 9px 18px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Toast notifiche */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      background: var(--surface);
      border-left: 4px solid var(--success);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 13px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      animation: slideIn .3s ease;
      min-width: 260px;
    }

    .toast.error {
      border-color: var(--danger);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Skeleton loading */
    .skeleton {
      background: linear-gradient(90deg, var(--bg) 25%, var(--border) 50%, var(--bg) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 6px;
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }
  </style>
</head>

<body>

  <!-- ============================================================
     TOAST CONTAINER
============================================================ -->
  <div id="toast-container"></div>

  <!-- ============================================================
     SCREEN: LOGIN/REGISTRAZIONE
============================================================ -->
  <div id="screen-login">
    <div class="login-card">
      <div class="login-logo">
        <div class="logo-icon">üí¨</div>
        <h1>Customer Service</h1>
        <p>Dashboard Operatori</p>
      </div>
      
      <!-- Toggle Login/Registrazione -->
      <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 16px;">
        <button type="button" id="btn-mode-login" class="mode-btn active">Accedi</button>
        <button type="button" id="btn-mode-register" class="mode-btn">Registrati</button>
      </div>

      <form id="login-form" autocomplete="on">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" placeholder="operatore@negozio.com" required autocomplete="email" />
        </div>
        <div class="form-group" id="password-group">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password" />
        </div>
        <div class="form-group" id="confirm-password-group" style="display: none;">
          <label for="confirm-password">Conferma Password</label>
          <input type="password" id="confirm-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
        </div>
        <button type="submit" class="btn-primary" id="login-btn">Accedi</button>
        <div style="text-align: center; margin-top: 12px;">
          <a href="#" id="link-reset-password" style="color: var(--primary); text-decoration: none; font-size: 13px;">
            Password dimenticata?
          </a>
        </div>
        <div id="login-error"></div>
      </form>
    </div>
  </div>

  <!-- ============================================================
     SCREEN: APP
============================================================ -->
  <div id="screen-app" style="display:none;">

    <!-- Header -->
    <div id="app-header">
      <div class="header-logo">üí¨ CS Dashboard</div>
      <div id="header-tabs">
        <button class="tab-btn active" data-tab="conversations">Conversazioni</button>
        <button class="tab-btn" data-tab="admin" id="tab-admin" style="display:none;">Admin</button>
      </div>
      <div id="header-user">
        Ciao, <strong id="header-user-name">‚Äî</strong>
        <button class="btn-logout" id="btn-logout">Esci</button>
      </div>
    </div>

    <!-- Body -->
    <div id="app-body">

      <!-- SIDEBAR -->
      <div id="sidebar">
        <div id="sidebar-header">
          <h2>Conversazioni <span id="sidebar-badge" class="badge badge-escalation"></span></h2>
        </div>
        <div id="sidebar-filters">
          <div class="filter-group">
            <div class="filter-label">Stato</div>
            <div class="filter-buttons">
              <button class="filter-btn active" data-filter="escalation">In attesa</button>
              <button class="filter-btn" data-filter="all">Tutte</button>
              <button class="filter-btn" data-filter="chiusa">Chiuse</button>
            </div>
          </div>
          <div class="filter-group">
            <div class="filter-label">Canale</div>
            <div class="filter-buttons">
              <button class="filter-btn channel-btn active" data-channel="all">Tutti</button>
              <button class="filter-btn channel-btn" data-channel="chat">üí¨ Chat</button>
              <button class="filter-btn channel-btn" data-channel="email">‚úâ Email</button>
            </div>
          </div>
        </div>
        <div id="conv-list">
          <div id="conv-empty">
            <div class="empty-icon">üéâ</div>
            <div>Nessuna conversazione in attesa</div>
          </div>
        </div>
      </div>

      <!-- MAIN AREA - Conversations Tab -->
      <div id="main-area">
        <div id="conv-placeholder">
          <div class="ph-icon">üí¨</div>
          <h3>Seleziona una conversazione</h3>
          <p>Clicca su una conversazione nella sidebar per iniziare</p>
        </div>
        <div id="conv-detail">
          <div id="conv-info">
            <div id="conv-info-text">
              <div id="conv-info-email">‚Äî</div>
              <div id="conv-info-meta">‚Äî</div>
            </div>
            <div id="conv-info-actions">
              <button class="btn-action btn-chiudi" id="btn-chiudi-conv">Chiudi sessione</button>
            </div>
          </div>
          <div id="conv-messages"></div>
          <div id="conv-reply">
            <div id="reply-email-fields" style="display: none; margin-bottom: 8px;">
              <input type="text" id="reply-subject" placeholder="Oggetto email..." style="width: 100%; padding: 8px 12px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 13px; outline: none;" />
            </div>
            <div>
              <textarea id="reply-input" rows="1" placeholder="Scrivi una risposta..."></textarea>
              <button id="btn-send-reply">Invia risposta</button>
            </div>
            <div id="typing-indicator" style="display: none; font-size: 12px; color: var(--text-muted); margin-top: 4px; font-style: italic;">‚úçÔ∏è Sta scrivendo...</div>
          </div>
        </div>
      </div>

      <!-- ADMIN VIEW -->
      <div id="admin-view">
        <!-- Admin Negozio: Gestione Operatori -->
        <div id="admin-negozio-section" style="display: none;">
          <div class="admin-header">
            <h2>Gestione Operatori</h2>
            <button class="btn-add" id="btn-add-operatore">+ Aggiungi Operatore</button>
          </div>
          <div class="stats-grid" id="operatori-stats">
            <div class="stat-card">
              <div class="stat-label">Operatori Totali</div>
              <div class="stat-value" id="stat-operatori-totali">‚Äî</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Operatori Attivi</div>
              <div class="stat-value" id="stat-operatori-attivi">‚Äî</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">In Attesa Registrazione</div>
              <div class="stat-value" id="stat-operatori-pending">‚Äî</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Conversazioni Oggi</div>
              <div class="stat-value" id="stat-conv-negozio">‚Äî</div>
            </div>
          </div>
          <div class="negozi-table">
            <div class="table-header">Lista Operatori</div>
            <table>
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Email</th>
                  <th>Ruolo</th>
                  <th>Stato Registrazione</th>
                  <th>Data Creazione</th>
                  <th>Azioni</th>
                </tr>
              </thead>
              <tbody id="operatori-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div><!-- /app-body -->
  </div><!-- /screen-app -->

  <!-- Modal Aggiungi/Modifica Operatore -->
  <div id="modal-operatore">
    <div class="modal-card">
      <h3 id="modal-operatore-title">‚ûï Nuovo Operatore</h3>
      <form id="form-operatore">
        <div class="form-group">
          <label>Nome Operatore *</label>
          <input type="text" id="o-nome" required placeholder="Mario Rossi" />
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="o-email" required placeholder="operatore@example.com" />
        </div>
        <div class="form-group">
          <label>Ruolo *</label>
          <select id="o-ruolo" required>
            <option value="operatore">Operatore</option>
            <option value="admin">Admin Negozio</option>
          </select>
        </div>
        <div id="o-status-info" style="display: none; padding: 12px; background: #f0f9ff; border-radius: 8px; margin-bottom: 16px; font-size: 13px; color: #0369a1;">
          <strong>Stato:</strong> <span id="o-status-text"></span><br>
          <small id="o-status-detail"></small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" id="btn-cancel-modal-operatore">Annulla</button>
          <button type="submit" class="btn-save" id="btn-save-operatore">Salva Operatore</button>
          <button type="button" class="btn-cancel" id="btn-delete-operatore" style="display: none; background: #ef4444; color: white; margin-left: auto;">Elimina</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ================================================================
    // CONFIGURAZIONE ‚Äî carica da config.js (locale) o config.prod.js (produzione)
    // ================================================================
    // Priorit√†: config.js (sviluppo locale) > config.prod.js (produzione)
    var SUPABASE_URL = window.DASHBOARD_CONFIG?.SUPABASE_URL || 
                       window.DASHBOARD_CONFIG_PROD?.SUPABASE_URL || '';
    var SUPABASE_ANON_KEY = window.DASHBOARD_CONFIG?.SUPABASE_ANON_KEY || 
                            window.DASHBOARD_CONFIG_PROD?.SUPABASE_ANON_KEY || '';
    var N8N_WEBHOOK_URL = window.DASHBOARD_CONFIG?.N8N_WEBHOOK_URL || 
                          window.DASHBOARD_CONFIG_PROD?.N8N_WEBHOOK_URL || '';
    var ADMIN_EMAIL = window.DASHBOARD_CONFIG?.ADMIN_EMAIL || 
                      window.DASHBOARD_CONFIG_PROD?.ADMIN_EMAIL || '';
    
    // Verifica che la configurazione sia presente
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      console.error('ERRORE: Configurazione mancante!');
      // Mostra alert solo in sviluppo locale
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        alert('Errore di configurazione: file config.js o config.prod.js mancante. Controlla la console.');
      }
    }

    // ================================================================
    // STATO APP
    // ================================================================
    var supabase;
    var currentUser = null;
    var currentNegozioId = null;
    var isAdmin = false;
    var currentUserNome = null;
    var currentUserRuolo = null;
    var activeSession = null;
    var activeFilter = 'escalation';
    var activeChannelFilter = 'all'; // 'all', 'chat', 'email'
    var allSessions = [];
    var refreshTimer = null;
    var sessionSubscription = null;
    var messagesSubscription = null;
    var unreadCounts = {}; // session_id -> count
    var lastReadTimestamps = {}; // session_id -> timestamp
    var typingTimeout = null;
    var currentCanale = null; // canale della conversazione corrente

    // ================================================================
    // INIT
    // ================================================================
    document.addEventListener('DOMContentLoaded', function () {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      checkSession();
      bindStaticEvents();
    });

    function checkSession() {
      supabase.auth.getSession().then(function (res) {
        if (res.data && res.data.session) {
          onLogin(res.data.session.user);
        }
      });
    }

    // ================================================================
    // LOGIN E REGISTRAZIONE
    // ================================================================
    var isRegisterMode = false;

    // Toggle tra login e registrazione
    document.getElementById('btn-mode-login').addEventListener('click', function() {
      isRegisterMode = false;
      document.getElementById('btn-mode-login').classList.add('active');
      document.getElementById('btn-mode-register').classList.remove('active');
      document.getElementById('login-btn').textContent = 'Accedi';
      document.getElementById('confirm-password-group').style.display = 'none';
      document.getElementById('login-password').required = true;
      document.getElementById('confirm-password').required = false;
    });

    document.getElementById('btn-mode-register').addEventListener('click', function() {
      isRegisterMode = true;
      document.getElementById('btn-mode-register').classList.add('active');
      document.getElementById('btn-mode-login').classList.remove('active');
      document.getElementById('login-btn').textContent = 'Registrati';
      document.getElementById('confirm-password-group').style.display = 'block';
      document.getElementById('login-password').required = true;
      document.getElementById('confirm-password').required = true;
    });

    // Form submit
    document.getElementById('login-form').addEventListener('submit', function (e) {
      e.preventDefault();
      var email = document.getElementById('login-email').value.trim();
      var password = document.getElementById('login-password').value;
      var confirmPassword = document.getElementById('confirm-password').value;
      var btn = document.getElementById('login-btn');
      var errEl = document.getElementById('login-error');

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>';
      errEl.style.display = 'none';

      // Validazione registrazione
      if (isRegisterMode) {
        if (password !== confirmPassword) {
          btn.disabled = false;
          btn.textContent = 'Registrati';
          errEl.textContent = 'Le password non corrispondono';
          errEl.style.display = 'block';
          return;
        }
        if (password.length < 6) {
          btn.disabled = false;
          btn.textContent = 'Registrati';
          errEl.textContent = 'La password deve essere di almeno 6 caratteri';
          errEl.style.display = 'block';
          return;
        }
      }

      var endpoint = isRegisterMode ? 'auth-register' : 'auth-login';
      
      fetch(SUPABASE_URL + '/functions/v1/' + endpoint, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
        },
        body: JSON.stringify({ email: email, password: password })
      })
        .then(function (r) {
          console.log('Status risposta:', r.status, r.statusText); // DEBUG
          // Clona la risposta per poterla leggere pi√π volte se necessario
          const responseClone = r.clone();
          // Leggi sempre il JSON, anche se c'√® un errore
          return r.json().then(function(data) {
            console.log('Risposta funzione:', data); // DEBUG
            if (!r.ok) {
              // Se c'√® un errore, mostra il messaggio specifico dalla funzione
              throw new Error(data.error || 'Errore server: ' + r.status);
            }
            return data;
          }).catch(function(jsonError) {
            console.error('Errore parsing JSON:', jsonError, 'Status:', r.status); // DEBUG
            // Se non riesce a parsare il JSON (es. risposta vuota), mostra errore generico
            if (!r.ok) {
              // Usa il clone per leggere il testo della risposta (il body originale √® gi√† stato letto)
              return responseClone.text().then(function(text) {
                console.error('Risposta non-JSON (testo):', text); // DEBUG
                // Prova a parsare come JSON se sembra essere JSON
                try {
                  const jsonData = JSON.parse(text);
                  console.log('JSON parsato dal testo:', jsonData); // DEBUG
                  throw new Error(jsonData.error || 'Errore server: ' + r.status);
                } catch (parseError) {
                  // Se il parse ha successo ma non c'√® error, o se il parse fallisce
                  if (parseError.message && parseError.message !== 'Errore server: ' + r.status) {
                    // Se abbiamo un messaggio di errore valido, usalo
                    throw parseError;
                  }
                  throw new Error('Errore server: ' + r.status + ' - ' + r.statusText);
                }
              });
            }
            // Se √® un errore di parsing JSON ma la risposta √® ok, rilancia l'errore originale
            throw jsonError;
          });
        })
        .then(function (data) {
          btn.disabled = false;
          btn.textContent = isRegisterMode ? 'Registrati' : 'Accedi';
          if (data.error) {
            errEl.textContent = data.error;
            errEl.style.display = 'block';
          } else if (data.session) {
            // Imposta la sessione Supabase
            supabase.auth.setSession({
              access_token: data.session.access_token,
              refresh_token: data.session.refresh_token
            }).then(function (res) {
              if (res.data && res.data.user) {
                if (isRegisterMode) {
                  showToast('Registrazione completata! Accesso effettuato.');
                }
                onLogin(res.data.user);
              } else if (res.error) {
                errEl.textContent = 'Errore nella sessione: ' + res.error.message;
                errEl.style.display = 'block';
              }
            });
          }
        })
        .catch(function (err) {
          btn.disabled = false;
          btn.textContent = isRegisterMode ? 'Registrati' : 'Accedi';
          // Log dell'errore nella console per debug
          console.error('Errore registrazione:', err);
          // Mostra il messaggio di errore specifico (che ora contiene il messaggio dalla funzione)
          errEl.textContent = err.message || 'Errore di connessione. Riprova.';
          errEl.style.display = 'block';
        });
    });

    // Reset password
    document.getElementById('link-reset-password').addEventListener('click', function(e) {
      e.preventDefault();
      var email = prompt('Inserisci la tua email per reimpostare la password:');
      if (!email) return;

      fetch(SUPABASE_URL + '/functions/v1/auth-reset-password', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
        },
        body: JSON.stringify({ email: email })
      })
        .then(function (r) { return r.json(); })
        .then(function (data) {
          if (data.error) {
            alert('Errore: ' + data.error);
          } else {
            // In produzione, il link sar√† inviato via email
            // Per ora mostriamo il link (rimuovi in produzione)
            if (data.resetLink) {
              alert('Link di reset: ' + data.resetLink + '\n\n(Questo √® solo per test. In produzione verr√† inviato via email)');
            } else {
              alert('Link di reset inviato via email!');
            }
          }
        });
    });

    function onLogin(user) {
      currentUser = user;
      document.getElementById('screen-login').style.display = 'none';
      document.getElementById('screen-app').style.display = 'flex';

      // Carica negozio corrente e dati operatore
      loadUserNegozio();
    }

    document.getElementById('btn-logout').addEventListener('click', function () {
      supabase.auth.signOut().then(function () {
        location.reload();
      });
    });

    // ================================================================
    // CARICA NEGOZIO UTENTE
    // ================================================================
    function loadUserNegozio() {
      supabase
        .from('operatori')
        .select('negozio_id, ruolo, nome, negozi(nome)')
        .eq('user_id', currentUser.id)
        .single()
        .then(function (res) {
          if (res.data) {
            currentNegozioId = res.data.negozio_id;
            currentUserRuolo = res.data.ruolo;
            currentUserNome = res.data.nome || currentUser.email.split('@')[0];
            
            // Admin negozio pu√≤ vedere la vista admin
            isAdmin = (res.data.ruolo === 'admin');
            if (isAdmin) {
              document.getElementById('tab-admin').style.display = 'inline';
            }
            
            // Mostra nome nell'header
            document.getElementById('header-user-name').textContent = currentUserNome;
          } else {
            // Fallback se non trova operatore
            currentUserNome = currentUser.email.split('@')[0];
            document.getElementById('header-user-name').textContent = currentUserNome;
          }
          startApp();
        });
    }

    // ================================================================
    // AVVIA DASHBOARD
    // ================================================================
    function startApp() {
      loadConversations();
      refreshTimer = setInterval(loadConversations, 10000); // auto-refresh 10s

      if (isAdmin) {
        loadAdminStats();
      }

      setupRealtime();
    }

    // ================================================================
    // REALTIME SETUP
    // ================================================================
    function setupRealtime() {
      if (sessionSubscription) sessionSubscription.unsubscribe();

      // Sottoscrizione alle sessioni (per vedere nuove escalation o cambi stato)
      sessionSubscription = supabase
        .channel('sessioni-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'sessioni' }, function (payload) {
          console.log('Update sessione:', payload);
          
          // Se √® una nuova escalation, suona la notifica
          if (payload.new && payload.new.stato === 'escalation') {
            // Controlla se √® una nuova escalation (INSERT) o se √® cambiata a escalation (UPDATE)
            var isNewEscalation = payload.eventType === 'INSERT' || 
              (payload.eventType === 'UPDATE' && payload.old && payload.old.stato !== 'escalation');
            
            if (isNewEscalation) {
              playNotificationSound();
              if (document.hidden || !document.hasFocus()) {
                var clienteName = payload.new.email_cliente || payload.new.nome_cliente || 'Cliente';
                showBrowserNotification('Nuova escalation', 'Nuova conversazione richiede attenzione: ' + clienteName);
              }
            }
          }
          
          loadConversations(); // Ricarica la lista per sicurezza

          // Se √® il cambio stato della sessione attiva
          if (activeSession && payload.new && payload.new.session_id === activeSession) {
            if (payload.new.stato === 'chiusa') {
              showToast('La sessione √® stata chiusa.');
              activeSession = null;
              if (window.messagePolling) clearInterval(window.messagePolling);
              document.getElementById('conv-detail').classList.remove('visible');
              document.getElementById('conv-placeholder').style.display = 'flex';
            }
          }
        })
        .subscribe();
    }

    function setupMessageRealtime(sessionId) {
      if (messagesSubscription) messagesSubscription.unsubscribe();

      messagesSubscription = supabase
        .channel('msgs-' + sessionId)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'conversazioni',
          filter: 'session_id=eq.' + sessionId
        }, function (payload) {
          console.log('Nuovo messaggio realtime:', payload.new);
          var newMsg = payload.new;
          
          // Se il messaggio √® dalla conversazione attiva, ricarica i messaggi
          // Usa un piccolo delay per evitare race conditions
          if (activeSession === sessionId) {
            var sessione = allSessions.find(function (s) { return s.session_id === sessionId; });
            if (sessione) {
              // Delay di 300ms per permettere al database di completare la transazione
              setTimeout(function() {
                if (activeSession === sessionId) {
                  loadMessages(sessionId, sessione.negozio_id, true);
                }
              }, 300);
            }
          } else {
            // Se non √® la conversazione attiva, incrementa il contatore non letti
            if (newMsg.ruolo === 'utente') {
              unreadCounts[sessionId] = (unreadCounts[sessionId] || 0) + 1;
              updateUnreadBadge(sessionId);
            }
          }
          
          // Aggiorna la sidebar per mostrare il nuovo messaggio (con delay)
          setTimeout(function() {
            loadConversations();
          }, 200);
        })
        .subscribe();
    }

    // ================================================================
    // CARICA CONVERSAZIONI
    // ================================================================
    function loadConversations() {
      var query = supabase
        .from('sessioni')
        .select('*')
        .order('updated_at', { ascending: false });

      if (!isAdmin && currentNegozioId) {
        query = query.eq('negozio_id', currentNegozioId);
      }

      if (activeFilter === 'escalation') {
        query = query.eq('stato', 'escalation');
      } else if (activeFilter === 'chiusa') {
        query = query.eq('stato', 'chiusa');
      }

      console.log('Eseguo query conversazioni...', { isAdmin, currentNegozioId, activeFilter });

      query.then(function (res) {
        if (res.error) {
          console.error('Errore Supabase:', res.error);
          return showToast('Errore caricamento: ' + res.error.message, true);
        }
        console.log('Sessioni trovate:', res.data);
        allSessions = res.data || [];
        
        // Carica ultimi messaggi e canali per ogni sessione
        loadLastMessagesForSessions(allSessions);
      });
    }
    
    // Carica ultimi messaggi e canali per ogni sessione
    function loadLastMessagesForSessions(sessions) {
      if (sessions.length === 0) {
        renderSidebar(sessions);
        return;
      }
      
      var sessionIds = sessions.map(function(s) { return s.session_id; });
      
      // Carica ultimo messaggio e canale per ogni sessione
      // Query unica per tutte le sessioni, poi filtriamo per prendere solo l'ultimo per sessione
      supabase
        .from('conversazioni')
        .select('session_id, messaggio, canale, created_at, ruolo')
        .in('session_id', sessionIds)
        .order('created_at', { ascending: false })
        .then(function (res) {
          var lastMessagesMap = {};
          var canaliMap = {};
          
          if (res.data) {
            // Prendi solo il primo messaggio (pi√π recente) per ogni session_id
            var seenSessions = {};
            res.data.forEach(function (msg) {
              if (!seenSessions[msg.session_id]) {
                lastMessagesMap[msg.session_id] = msg.messaggio;
                canaliMap[msg.session_id] = msg.canale || 'chat';
                seenSessions[msg.session_id] = true;
              }
            });
          }
          
          // Aggiungi dati alle sessioni
          sessions.forEach(function (s) {
            s.lastMessage = lastMessagesMap[s.session_id] || null;
            s.canale = canaliMap[s.session_id] || 'chat';
          });
          
          renderSidebar(sessions);
        }).catch(function(err) {
          console.error('Errore caricamento ultimi messaggi:', err);
          // In caso di errore, usa valori di default
          sessions.forEach(function (s) {
            s.lastMessage = null;
            s.canale = 'chat';
          });
          renderSidebar(sessions);
        });
    }

    // ================================================================
    // RENDER SIDEBAR
    // ================================================================
    function renderSidebar(sessions) {
      var list = document.getElementById('conv-list');
      var badge = document.getElementById('sidebar-badge');
      var empty = document.getElementById('conv-empty');

      // Filtra per canale se necessario
      var filteredSessions = sessions;
      if (activeChannelFilter !== 'all') {
        filteredSessions = sessions.filter(function (s) {
          return (s.canale || 'chat') === activeChannelFilter;
        });
      }

      var escalationCount = filteredSessions.filter(function (s) { return s.stato === 'escalation'; }).length;
      badge.textContent = escalationCount;
      badge.classList.toggle('visible', escalationCount > 0);

      if (filteredSessions.length === 0) {
        list.innerHTML = '';
        if (empty) empty.style.display = 'block';
        return;
      }

      if (empty) empty.style.display = 'none';
      list.innerHTML = '';

      filteredSessions.forEach(function (s) {
        var lastMsg = s.lastMessage || '(nessun messaggio)';
        var lastCanale = s.canale || 'chat';
        if (lastMsg.length > 55) lastMsg = lastMsg.slice(0, 55) + '‚Ä¶';

        var timeStr = s.updated_at ? new Date(s.updated_at).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : '';
        var badgeHtml = '';
        if (s.stato === 'escalation') badgeHtml = '<span class="badge badge-escalation">‚ö† In attesa</span>';
        else if (s.stato === 'ai') badgeHtml = '<span class="badge badge-ai">ü§ñ AI</span>';
        else badgeHtml = '<span class="badge badge-chiusa">‚úì Chiusa</span>';

        var canaleBadge = '<span class="badge badge-canale">' + (lastCanale === 'email' ? '‚úâ Email' : 'üí¨ Chat') + '</span>';
        
        // Contatore messaggi non letti
        var unreadBadge = '';
        var unreadCount = unreadCounts[s.session_id] || 0;
        if (unreadCount > 0 && activeSession !== s.session_id) {
          unreadBadge = '<span class="badge badge-unread">' + (unreadCount > 99 ? '99+' : unreadCount) + '</span>';
        }

        // Nome cliente - migliorato per raccogliere email/nome
        var clienteLabel = s.email_cliente || s.nome_cliente || 'Cliente anonimo';
        // Se abbiamo solo email, estrai il nome prima della @ se possibile
        if (clienteLabel.includes('@') && !s.nome_cliente) {
          var emailParts = clienteLabel.split('@');
          if (emailParts[0]) {
            clienteLabel = emailParts[0].charAt(0).toUpperCase() + emailParts[0].slice(1);
          }
        }

        var div = document.createElement('div');
        div.className = 'conv-item' + (activeSession === s.session_id ? ' active' : '');
        div.dataset.session = s.session_id;
        div.innerHTML = [
          '<div class="conv-item-header">',
          '<span class="conv-item-name">' + escHtml(clienteLabel) + '</span>',
          '<span class="conv-item-time">' + timeStr + '</span>',
          '</div>',
          '<div class="conv-item-preview">' + escHtml(lastMsg) + '</div>',
          '<div class="conv-item-footer" style="display: flex; align-items: center; gap: 6px;">' + badgeHtml + canaleBadge + unreadBadge + '</div>'
        ].join('');

        div.addEventListener('click', function () {
          openConversation(s);
        });

        list.appendChild(div);
      });
    }
    
    function updateUnreadBadge(sessionId) {
      var item = document.querySelector('.conv-item[data-session="' + sessionId + '"]');
      if (!item) return;
      
      var footer = item.querySelector('.conv-item-footer');
      if (!footer) return;
      
      // Rimuovi badge esistente
      var existingBadge = footer.querySelector('.badge-unread');
      if (existingBadge) existingBadge.remove();
      
      // Aggiungi nuovo badge se necessario
      var unreadCount = unreadCounts[sessionId] || 0;
      if (unreadCount > 0 && activeSession !== sessionId) {
        var unreadBadge = '<span class="badge badge-unread">' + (unreadCount > 99 ? '99+' : unreadCount) + '</span>';
        footer.insertAdjacentHTML('beforeend', unreadBadge);
      }
    }

    // ================================================================
    // APRI CONVERSAZIONE
    // ================================================================
    function openConversation(sessione) {
      // Ferma il polling precedente se esiste
      if (window.messagePolling) {
        clearInterval(window.messagePolling);
        window.messagePolling = null;
      }
      
      activeSession = sessione.session_id;
      currentCanale = sessione.canale || 'chat';

      // Reset contatore non letti per questa sessione
      unreadCounts[sessione.session_id] = 0;
      lastReadTimestamps[sessione.session_id] = Date.now();
      updateUnreadBadge(sessione.session_id);

      // Aggiorna sidebar highlight
      document.querySelectorAll('.conv-item').forEach(function (el) {
        el.classList.toggle('active', el.dataset.session === activeSession);
      });

      document.getElementById('conv-placeholder').style.display = 'none';
      var detail = document.getElementById('conv-detail');
      detail.classList.add('visible');

      // Info cliente
      var emailLabel = sessione.email_cliente || sessione.nome_cliente || 'Cliente anonimo';
      if (emailLabel.includes('@') && !sessione.nome_cliente) {
        var emailParts = emailLabel.split('@');
        if (emailParts[0]) {
          emailLabel = emailParts[0].charAt(0).toUpperCase() + emailParts[0].slice(1);
        }
      }
      document.getElementById('conv-info-email').textContent = emailLabel;
      document.getElementById('conv-info-meta').textContent =
        'Sessione: ' + sessione.session_id.slice(0, 20) + '‚Ä¶ | Stato: ' + sessione.stato +
        ' | Canale: ' + (currentCanale === 'email' ? '‚úâ Email' : 'üí¨ Chat') +
        ' | Aperta: ' + (sessione.created_at ? new Date(sessione.created_at).toLocaleString('it-IT') : '‚Äî');

      // Mostra/nascondi campo oggetto per email
      var emailFields = document.getElementById('reply-email-fields');
      if (currentCanale === 'email') {
        emailFields.style.display = 'block';
      } else {
        emailFields.style.display = 'none';
        document.getElementById('reply-subject').value = '';
      }

      // Setup Realtime per i messaggi di QUESTA sessione
      setupMessageRealtime(sessione.session_id);

      // Polling fallback per i messaggi (ogni 3 secondi in modo silenzioso)
      window.messagePolling = setInterval(function() {
        if (activeSession === sessione.session_id) {
          loadMessages(sessione.session_id, sessione.negozio_id, true);
        } else {
          // Se la sessione attiva √® cambiata, ferma il polling
          clearInterval(window.messagePolling);
          window.messagePolling = null;
        }
      }, 3000);

      // Carica messaggi
      loadMessages(sessione.session_id, sessione.negozio_id);
    }

    var isLoadingMessages = false; // Flag per evitare chiamate multiple simultanee
    var lastLoadTime = {}; // Traccia l'ultimo caricamento per sessione
    var loadMessagesDebounce = {}; // Debounce per evitare chiamate troppo frequenti

    function loadMessages(sessionId, negozioId, silent) {
      // Se non √® la sessione attiva, non caricare
      if (activeSession !== sessionId) {
        return;
      }
      
      // Debounce: evita chiamate troppo frequenti (minimo 500ms tra una chiamata e l'altra)
      var now = Date.now();
      var lastTime = lastLoadTime[sessionId] || 0;
      if (now - lastTime < 500 && !silent) {
        // Cancella il timeout precedente se esiste
        if (loadMessagesDebounce[sessionId]) {
          clearTimeout(loadMessagesDebounce[sessionId]);
        }
        // Programma un nuovo caricamento dopo il debounce
        loadMessagesDebounce[sessionId] = setTimeout(function() {
          loadMessages(sessionId, negozioId, true);
        }, 500 - (now - lastTime));
        return;
      }
      
      // Evita chiamate multiple simultanee
      if (isLoadingMessages && !silent) {
        return;
      }
      
      isLoadingMessages = true;
      lastLoadTime[sessionId] = Date.now();
      
      var msgsEl = document.getElementById('conv-messages');
      if (!silent) {
        msgsEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Caricamento...</div>';
      }

      supabase
        .from('conversazioni')
        .select('id, session_id, messaggio, ruolo, created_at, canale')
        .eq('session_id', sessionId)
        .order('created_at', { ascending: true })
        .then(function (res) {
          isLoadingMessages = false;
          if (res.error) {
            console.error('Errore caricamento messaggi:', res.error);
            return;
          }
          
          // Verifica ancora che sia la sessione attiva prima di renderizzare
          if (activeSession === sessionId) {
            // Filtra i messaggi nulli o vuoti
            var validMsgs = (res.data || []).filter(function(msg) {
              return msg && msg.messaggio && msg.messaggio.trim().length > 0;
            });
            
            renderMessages(validMsgs);
            
            // Aggiorna timestamp ultima lettura
            lastReadTimestamps[sessionId] = Date.now();
            unreadCounts[sessionId] = 0;
            updateUnreadBadge(sessionId);
          }
        })
        .catch(function(err) {
          isLoadingMessages = false;
          console.error('Errore caricamento messaggi:', err);
        });
    }

    function renderMessages(msgs) {
      var el = document.getElementById('conv-messages');
      
      if (!msgs || msgs.length === 0) {
        el.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Nessun messaggio</div>';
        return;
      }

      // Rimuovi duplicati in modo pi√π robusto
      var seenMessages = new Map();
      var uniqueMsgs = [];
      
      // Ordina per created_at per assicurarsi che i messaggi pi√π recenti abbiano priorit√†
      var sortedMsgs = msgs.slice().sort(function(a, b) {
        var timeA = a.created_at ? new Date(a.created_at).getTime() : 0;
        var timeB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return timeB - timeA; // Pi√π recenti prima
      });
      
      sortedMsgs.forEach(function (msg) {
        // Crea una chiave unica pi√π robusta
        var msgText = (msg.messaggio || '').trim();
        var msgTime = msg.created_at ? new Date(msg.created_at).getTime() : 0;
        var msgRole = msg.ruolo || 'unknown';
        
        // Usa id se disponibile (pi√π affidabile)
        var key = msg.id ? 'id_' + msg.id : null;
        
        // Se non c'√® id, crea una chiave basata su contenuto + tempo + ruolo
        // Arrotonda il tempo al secondo per gestire piccole differenze
        if (!key) {
          var timeKey = Math.floor(msgTime / 1000); // Arrotonda al secondo
          key = 'msg_' + timeKey + '_' + msgRole + '_' + msgText.substring(0, 100);
        }
        
        // Controlla se questo messaggio √® gi√† stato visto
        // Se esiste gi√† un messaggio con la stessa chiave, salta questo
        if (!seenMessages.has(key)) {
          seenMessages.set(key, true);
          uniqueMsgs.push(msg);
        }
      });
      
      // Riordina per data crescente per la visualizzazione
      uniqueMsgs.sort(function(a, b) {
        var timeA = a.created_at ? new Date(a.created_at).getTime() : 0;
        var timeB = b.created_at ? new Date(b.created_at).getTime() : 0;
        return timeA - timeB; // Pi√π vecchi prima
      });

      // Pulisci e renderizza
      el.innerHTML = '';
      
      uniqueMsgs.forEach(function (msg) {
        var row = document.createElement('div');
        var ruolo = msg.ruolo === 'assistente' ? 'assistente' : msg.ruolo;
        row.className = 'msg-row ' + ruolo;
        
        // Aggiungi data-id o data-key per riferimento futuro
        if (msg.id) {
          row.dataset.msgId = msg.id;
        } else {
          var msgText = (msg.messaggio || '').trim();
          var msgTime = msg.created_at ? new Date(msg.created_at).getTime() : 0;
          var timeKey = Math.floor(msgTime / 1000);
          row.dataset.msgKey = 'msg_' + timeKey + '_' + msg.ruolo + '_' + msgText.substring(0, 50);
        }
        
        var labelMap = { utente: 'üë§ Cliente', assistente: 'ü§ñ AI', operatore: '‚úâ Operatore' };
        var timeStr = msg.created_at ? new Date(msg.created_at).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : '';
        row.innerHTML = [
          '<div class="msg-label">' + (labelMap[ruolo] || ruolo) + '</div>',
          '<div class="msg-bubble">' + escHtml(msg.messaggio) + '</div>',
          '<div class="msg-time">' + timeStr + '</div>'
        ].join('');
        el.appendChild(row);
      });

      el.scrollTop = el.scrollHeight;
    }

    // ================================================================
    // INVIA RISPOSTA OPERATORE
    // ================================================================
    document.getElementById('btn-send-reply').addEventListener('click', sendOperatorReply);
    document.getElementById('reply-input').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendOperatorReply();
      }
    });

    function sendOperatorReply() {
      var input = document.getElementById('reply-input');
      var subjectInput = document.getElementById('reply-subject');
      var btn = document.getElementById('btn-send-reply');
      var msg = input.value.trim();
      var subject = currentCanale === 'email' ? subjectInput.value.trim() : null;
      
      if (!msg || !activeSession) return;
      
      // Se √® email e non c'√® oggetto, avvisa
      if (currentCanale === 'email' && !subject) {
        showToast('Inserisci un oggetto per l\'email', true);
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Invio...';

      var sessione = allSessions.find(function (s) { return s.session_id === activeSession; });
      if (!sessione) return;

      var payload = {
        session_id: activeSession,
        negozio_id: sessione.negozio_id,
        messaggio: msg,
        operatore_id: currentUser.id,
        chiudi: false
      };
      
      if (subject) {
        payload.oggetto = subject;
      }

      fetch(N8N_WEBHOOK_URL + '/webhook/risposta-operatore', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json' 
        },
        body: JSON.stringify(payload)
      })
        .then(function (r) { 
          if (!r.ok) throw new Error('Errore server n8n');
          return r.json(); 
        })
        .then(function (data) {
          btn.disabled = false;
          btn.textContent = 'Invia risposta';
          if (data.success) {
            input.value = '';
            input.style.height = 'auto';
            if (subjectInput) subjectInput.value = '';
            showToast('Risposta inviata con successo');
            loadMessages(activeSession, sessione.negozio_id, true);
            loadConversations(); // Aggiorna sidebar per mostrare nuovo messaggio
          } else {
            showToast('Errore nell\'invio: ' + (data.message || 'Riprova'), true);
          }
        })
        .catch(function (err) {
          console.error('Errore invio:', err);
          btn.disabled = false;
          btn.textContent = 'Invia risposta';
          showToast('Errore di rete: controlla n8n e ngrok', true);
        });
    }

    // Chiudi sessione
    document.getElementById('btn-chiudi-conv').addEventListener('click', function () {
      if (!activeSession) return;
      var sessione = allSessions.find(function (s) { return s.session_id === activeSession; });
      if (!sessione) return;

      // Usa il webhook per chiudere correttamente (cos√¨ l'operatore pu√≤ mandare un ultimo messaggio di chiusura se volesse)
      fetch(N8N_WEBHOOK_URL + '/webhook/risposta-operatore', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_id: activeSession,
          negozio_id: sessione.negozio_id,
          messaggio: '‚ö†Ô∏è Sessione chiusa dall\'operatore.',
          operatore_id: currentUser.id,
          chiudi: true
        })
      }).then(function() {
        showToast('Sessione chiusa');
        activeSession = null;
        currentCanale = null;
        if (window.messagePolling) {
          clearInterval(window.messagePolling);
          window.messagePolling = null;
        }
        document.getElementById('conv-detail').classList.remove('visible');
        document.getElementById('conv-placeholder').style.display = 'flex';
        loadConversations();
      });
    });

    // Auto-resize textarea
    document.getElementById('reply-input').addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      
      // Indicatore "sta scrivendo" - mostra quando l'operatore sta scrivendo
      var typingIndicator = document.getElementById('typing-indicator');
      if (this.value.trim().length > 0) {
        typingIndicator.style.display = 'block';
        if (typingTimeout) clearTimeout(typingTimeout);
        typingTimeout = setTimeout(function() {
          typingIndicator.style.display = 'none';
        }, 2000);
      } else {
        typingIndicator.style.display = 'none';
      }
    });

    // ================================================================
    // ADMIN: GESTIONE OPERATORI
    // ================================================================
    function loadAdminStats() {
      // Solo Admin Negozio pu√≤ vedere questa sezione
      if (isAdmin && currentNegozioId) {
        document.getElementById('admin-negozio-section').style.display = 'block';
        loadOperatori();
      }
    }

    // ================================================================
    // ADMIN NEGOZIO: GESTIONE OPERATORI
    // ================================================================
    function loadOperatori() {
      if (!currentNegozioId) return;

      // Carica operatori del negozio
      supabase
        .from('operatori')
        .select('id, nome, email, ruolo, password_hash, user_id, created_at')
        .eq('negozio_id', currentNegozioId)
        .order('created_at', { ascending: false })
        .then(function (r) {
          if (r.error) {
            console.error('Errore caricamento operatori:', r.error);
            showToast('Errore caricamento operatori: ' + r.error.message, true);
            return;
          }

          var operatori = r.data || [];
          var tbody = document.getElementById('operatori-tbody');
          tbody.innerHTML = '';

          // Statistiche
          var totali = operatori.length;
          var attivi = operatori.filter(function (o) { return o.password_hash !== null; }).length;
          var pending = operatori.filter(function (o) { return o.password_hash === null; }).length;

          document.getElementById('stat-operatori-totali').textContent = totali;
          document.getElementById('stat-operatori-attivi').textContent = attivi;
          document.getElementById('stat-operatori-pending').textContent = pending;

          // Conversazioni oggi del negozio
          var oggi = new Date(); oggi.setHours(0, 0, 0, 0);
          supabase
            .from('conversazioni')
            .select('id', { count: 'exact' })
            .eq('negozio_id', currentNegozioId)
            .gte('created_at', oggi.toISOString())
            .then(function (convRes) {
              document.getElementById('stat-conv-negozio').textContent = convRes.count || 0;
            });

          if (operatori.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 24px; color: var(--text-muted);">Nessun operatore ancora. Aggiungi il primo operatore!</td></tr>';
            return;
          }

          operatori.forEach(function (op) {
            var tr = document.createElement('tr');
            var isRegistrato = op.password_hash !== null;
            var statoReg = isRegistrato 
              ? '<span style="color: var(--success); font-weight: 600;">‚úì Registrato</span>'
              : '<span style="color: var(--warning); font-weight: 600;">‚è≥ In attesa</span>';
            var ruoloBadge = op.ruolo === 'admin' 
              ? '<span style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Admin</span>'
              : '<span style="background: var(--bg); color: var(--text-muted); padding: 2px 8px; border-radius: 4px; font-size: 11px;">Operatore</span>';
            var dataCreazione = op.created_at 
              ? new Date(op.created_at).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' })
              : '‚Äî';

            tr.innerHTML = [
              '<td><strong>' + escHtml(op.nome || '‚Äî') + '</strong></td>',
              '<td>' + escHtml(op.email || '‚Äî') + '</td>',
              '<td>' + ruoloBadge + '</td>',
              '<td>' + statoReg + '</td>',
              '<td>' + dataCreazione + '</td>',
              '<td><button class="btn-action" onclick="editOperatore(\'' + op.id + '\')" style="padding: 4px 12px; font-size: 12px;">Modifica</button></td>'
            ].join('');
            tbody.appendChild(tr);
          });
        });
    }

    // Variabile per tracciare operatore in modifica
    var editingOperatoreId = null;

    // Funzione globale per modificare operatore (chiamata da onclick)
    window.editOperatore = function(operatoreId) {
      editingOperatoreId = operatoreId;
      
      supabase
        .from('operatori')
        .select('*')
        .eq('id', operatoreId)
        .single()
        .then(function (r) {
          if (r.error || !r.data) {
            showToast('Errore caricamento operatore', true);
            return;
          }

          var op = r.data;
          document.getElementById('modal-operatore-title').textContent = '‚úèÔ∏è Modifica Operatore';
          document.getElementById('o-nome').value = op.nome || '';
          document.getElementById('o-email').value = op.email || '';
          document.getElementById('o-ruolo').value = op.ruolo || 'operatore';
          
          // Mostra info stato
          var statusInfo = document.getElementById('o-status-info');
          var statusText = document.getElementById('o-status-text');
          var statusDetail = document.getElementById('o-status-detail');
          var deleteBtn = document.getElementById('btn-delete-operatore');
          
          if (op.password_hash) {
            statusText.textContent = 'Registrato';
            statusDetail.textContent = 'L\'operatore ha completato la registrazione e pu√≤ accedere alla dashboard.';
            deleteBtn.style.display = 'none'; // Non permettere eliminazione se registrato
          } else {
            statusText.textContent = 'In attesa di registrazione';
            statusDetail.textContent = 'L\'operatore deve ancora completare la registrazione con email e password.';
            deleteBtn.style.display = 'inline-block';
          }
          
          statusInfo.style.display = 'block';
          document.getElementById('modal-operatore').classList.add('visible');
        });
    }


    // ================================================================
    // MODAL AGGIUNGI/MODIFICA OPERATORE
    // ================================================================
    document.getElementById('btn-add-operatore').addEventListener('click', function () {
      editingOperatoreId = null;
      document.getElementById('modal-operatore-title').textContent = '‚ûï Nuovo Operatore';
      document.getElementById('form-operatore').reset();
      document.getElementById('o-status-info').style.display = 'none';
      document.getElementById('btn-delete-operatore').style.display = 'none';
      document.getElementById('modal-operatore').classList.add('visible');
    });

    document.getElementById('btn-cancel-modal-operatore').addEventListener('click', function () {
      document.getElementById('modal-operatore').classList.remove('visible');
      editingOperatoreId = null;
    });

    document.getElementById('modal-operatore').addEventListener('click', function (e) {
      if (e.target === this) {
        this.classList.remove('visible');
        editingOperatoreId = null;
      }
    });

    document.getElementById('form-operatore').addEventListener('submit', function (e) {
      e.preventDefault();
      if (!currentNegozioId) {
        showToast('Errore: negozio non trovato', true);
        return;
      }

      var nome = document.getElementById('o-nome').value.trim();
      var email = document.getElementById('o-email').value.trim().toLowerCase();
      var ruolo = document.getElementById('o-ruolo').value;

      if (!nome || !email) {
        showToast('Nome e email sono obbligatori', true);
        return;
      }

      var data = {
        negozio_id: currentNegozioId,
        nome: nome,
        email: email,
        ruolo: ruolo,
        password_hash: null, // L'operatore completer√† la registrazione
        user_id: null
      };

      var promise;
      if (editingOperatoreId) {
        // Modifica operatore esistente
        // Non permettere modifica se √® gi√† registrato (solo nome e ruolo)
        supabase
          .from('operatori')
          .select('password_hash')
          .eq('id', editingOperatoreId)
          .single()
          .then(function (checkRes) {
            if (checkRes.data && checkRes.data.password_hash) {
              // Se registrato, permettere solo modifica nome e ruolo
              promise = supabase
                .from('operatori')
                .update({ nome: nome, ruolo: ruolo })
                .eq('id', editingOperatoreId);
            } else {
              // Se non registrato, permettere modifica completa
              promise = supabase
                .from('operatori')
                .update({ nome: nome, email: email, ruolo: ruolo })
                .eq('id', editingOperatoreId);
            }
            
            promise.then(function (res) {
              if (res.error) {
                showToast('Errore: ' + res.error.message, true);
              } else {
                showToast('Operatore aggiornato con successo!');
                document.getElementById('modal-operatore').classList.remove('visible');
                document.getElementById('form-operatore').reset();
                editingOperatoreId = null;
                loadOperatori();
              }
            });
          });
      } else {
        // Nuovo operatore
        promise = supabase.from('operatori').insert(data);
        promise.then(function (res) {
          if (res.error) {
            if (res.error.message.includes('unique') || res.error.message.includes('duplicate')) {
              showToast('Errore: questa email √® gi√† registrata', true);
            } else {
              showToast('Errore: ' + res.error.message, true);
            }
          } else {
            showToast('Operatore aggiunto con successo! Invia il link della dashboard per completare la registrazione.');
            document.getElementById('modal-operatore').classList.remove('visible');
            document.getElementById('form-operatore').reset();
            loadOperatori();
          }
        });
      }
    });

    // Elimina operatore
    document.getElementById('btn-delete-operatore').addEventListener('click', function () {
      if (!editingOperatoreId) return;
      
      if (!confirm('Sei sicuro di voler eliminare questo operatore? L\'operazione non pu√≤ essere annullata.')) {
        return;
      }

      supabase
        .from('operatori')
        .delete()
        .eq('id', editingOperatoreId)
        .then(function (res) {
          if (res.error) {
            showToast('Errore: ' + res.error.message, true);
          } else {
            showToast('Operatore eliminato con successo!');
            document.getElementById('modal-operatore').classList.remove('visible');
            document.getElementById('form-operatore').reset();
            editingOperatoreId = null;
            loadOperatori();
          }
        });
    });

    // ================================================================
    // TABS
    // ================================================================
    function bindStaticEvents() {
      document.getElementById('header-tabs').addEventListener('click', function (e) {
        var btn = e.target.closest('.tab-btn');
        if (!btn) return;
        var tab = btn.dataset.tab;

        document.querySelectorAll('.tab-btn').forEach(function (b) { b.classList.remove('active'); });
        btn.classList.add('active');

        var body = document.getElementById('app-body');
        var sidebar = document.getElementById('sidebar');
        var mainArea = document.getElementById('main-area');
        var adminView = document.getElementById('admin-view');

        if (tab === 'conversations') {
          sidebar.style.display = 'flex';
          mainArea.style.display = 'flex';
          adminView.classList.remove('visible');
        } else if (tab === 'admin') {
          sidebar.style.display = 'none';
          mainArea.style.display = 'none';
          adminView.classList.add('visible');
          loadAdminStats();
        }
      });

      // Filter buttons - stato
      var filterButtons = document.querySelectorAll('#sidebar-filters .filter-btn[data-filter]');
      filterButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          document.querySelectorAll('#sidebar-filters .filter-btn[data-filter]').forEach(function (b) { b.classList.remove('active'); });
          btn.classList.add('active');
          activeFilter = btn.dataset.filter;
          loadConversations();
        });
      });
      
      // Channel filter buttons
      var channelButtons = document.querySelectorAll('#sidebar-filters .filter-btn[data-channel]');
      channelButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          document.querySelectorAll('#sidebar-filters .filter-btn[data-channel]').forEach(function (b) { b.classList.remove('active'); });
          btn.classList.add('active');
          activeChannelFilter = btn.dataset.channel;
          loadConversations();
        });
      });
      
      // Imposta "Tutti" come attivo di default per il canale
      var allChannelBtn = document.querySelector('#sidebar-filters .filter-btn[data-channel="all"]');
      if (allChannelBtn) allChannelBtn.classList.add('active');
    }
    
    // ================================================================
    // NOTIFICHE E SUONI
    // ================================================================
    function playNotificationSound() {
      try {
        // Crea un suono breve usando Web Audio API
        var audioContext = new (window.AudioContext || window.webkitAudioContext)();
        var oscillator = audioContext.createOscillator();
        var gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) {
        console.log('Impossibile riprodurre suono:', e);
      }
    }
    
    function showBrowserNotification(title, body) {
      if (!('Notification' in window)) {
        return;
      }
      
      if (Notification.permission === 'granted') {
        new Notification(title, { body: body, icon: 'üí¨' });
      } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(function (permission) {
          if (permission === 'granted') {
            new Notification(title, { body: body, icon: 'üí¨' });
          }
        });
      }
    }
    
    // Richiedi permesso notifiche all'avvio
    if ('Notification' in window && Notification.permission === 'default') {
      // Non richiediamo automaticamente, ma possiamo farlo quando arriva la prima escalation
    }

    // ================================================================
    // TOAST
    // ================================================================
    function showToast(msg, isError) {
      var container = document.getElementById('toast-container');
      var toast = document.createElement('div');
      toast.className = 'toast' + (isError ? ' error' : '');
      toast.textContent = (isError ? '‚ùå ' : '‚úÖ ') + msg;
      container.appendChild(toast);
      setTimeout(function () {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity .3s';
        setTimeout(function () { toast.remove(); }, 300);
      }, 4000);
    }

    // ================================================================
    // UTILITY
    // ================================================================
    function escHtml(str) {
      var d = document.createElement('div');
      d.textContent = String(str || '');
      return d.innerHTML;
    }
  </script>
</body>

</html>